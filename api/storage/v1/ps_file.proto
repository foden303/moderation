syntax = "proto3";

package storage.v1;

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "api/common/v1/pagination.proto";

option go_package = "storage/api/storage/v1;v1";
// PsFile message definition
message PsFile {
  string id = 1;
  string hash = 2; // SHA-256 of the file
  int64 size = 3;
  bool encrypted = 4; // client-side encryption flag
  string mime_type = 5;
  string ext = 6; // file extension
  optional string checksum = 7; // original file checksum
  int32 total_chunks = 8;
  int32 reference_count = 9; // deduplication reference count
  string status = 10; // uploading | completed
  google.protobuf.Timestamp created_at = 11;
  google.protobuf.Timestamp updated_at = 12;
}
// The PsFile service definition
service PsFile {
  // Create a new physical file record
  rpc CreatePsFile(CreatePsFileRequest) returns (CreatePsFileResponse) {
    option (google.api.http) = {
      post: "/v1/ps-files"
      body: "*"
    };
  }

  // Get physical file by ID
  rpc GetPsFile(GetPsFileRequest) returns (GetPsFileResponse) {
    option (google.api.http) = {
      get: "/v1/ps-files/{id}"
    };
  }

  // Get physical file by hash (for deduplication)
  rpc GetPsFileByHash(GetPsFileByHashRequest) returns (GetPsFileByHashResponse) {
    option (google.api.http) = {
      get: "/v1/ps-files/hash/{hash}"
    };
  }

  // Check if physical file exists by hash
  rpc CheckPsFileExists(CheckPsFileExistsRequest) returns (CheckPsFileExistsResponse) {
    option (google.api.http) = {
      get: "/v1/ps-files/exists/{hash}"
    };
  }

  // List all physical files
  rpc ListPsFiles(ListPsFilesRequest) returns (ListPsFilesResponse) {
    option (google.api.http) = {
      get: "/v1/ps-files"
    };
  }

  // Update physical file status
  rpc UpdatePsFileStatus(UpdatePsFileStatusRequest) returns (UpdatePsFileStatusResponse) {
    option (google.api.http) = {
      patch: "/v1/ps-files/{id}/status"
      body: "*"
    };
  }

  // Increment reference count (when file is referenced by another user)
  rpc IncrementReferenceCount(IncrementReferenceCountRequest) returns (IncrementReferenceCountResponse) {
    option (google.api.http) = {
      post: "/v1/ps-files/{id}/reference"
      body: "*"
    };
  }

  // Decrement reference count (when file is deleted by a user)
  rpc DecrementReferenceCount(DecrementReferenceCountRequest) returns (DecrementReferenceCountResponse) {
    option (google.api.http) = {
      delete: "/v1/ps-files/{id}/reference"
    };
  }
}

// ========================================
// Request/Response Messages
// ========================================

// CreatePsFile
message CreatePsFileRequest {
  string hash = 1;
  int64 size = 2;
  bool encrypted = 3;
  string mime_type = 4;
  string ext = 5;
  optional string checksum = 6;
  int32 total_chunks = 7;
}

message CreatePsFileResponse {
  PsFile ps_file = 1;
}

// GetPsFile
message GetPsFileRequest {
  string id = 1;
}

message GetPsFileResponse {
  PsFile ps_file = 1;
}

// GetPsFileByHash
message GetPsFileByHashRequest {
  string hash = 1;
}

message GetPsFileByHashResponse {
  PsFile ps_file = 1;
}

// CheckPsFileExists
message CheckPsFileExistsRequest {
  string hash = 1;
}

message CheckPsFileExistsResponse {
  bool exists = 1;
  optional PsFile ps_file = 2; // Return file if exists
}

// ListPsFiles
message ListPsFilesRequest {
  common.v1.CursorPaginationRequest pagination = 1;
  optional string status = 2; // Filter by status
}

message ListPsFilesResponse {
  repeated PsFile ps_files = 1;
  common.v1.CursorPaginationResponse pagination = 2;
}

// UpdatePsFileStatus
message UpdatePsFileStatusRequest {
  string id = 1;
  string status = 2; // uploading | completed
}

message UpdatePsFileStatusResponse {
  PsFile ps_file = 1;
}

// IncrementReferenceCount
message IncrementReferenceCountRequest {
  string id = 1;
}

message IncrementReferenceCountResponse {
  int32 reference_count = 1;
}

// DecrementReferenceCount
message DecrementReferenceCountRequest {
  string id = 1;
}

message DecrementReferenceCountResponse {
  int32 reference_count = 1;
  bool deleted = 2; // True if file was deleted because reference_count reached 0
}
